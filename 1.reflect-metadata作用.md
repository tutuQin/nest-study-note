`reflect-metadata` çš„ç”¨æ³•è¿›è¡Œç³»ç»Ÿæ€§ã€å…¨è¦†ç›–çš„è®²è§£ï¼Œå†…å®¹æ¶µç›–ä»¥ä¸‹ç»“æ„ï¼š

---

## ğŸ§  ä¸€ã€åŸºç¡€æ¦‚å¿µä¸åŸç†

### 1.1 ä»€ä¹ˆæ˜¯ Reflect Metadataï¼Ÿ

* ECMAScript çš„ `Reflect` API åŸæœ¬æä¾›çš„æ˜¯å¯¹å¯¹è±¡æ“ä½œçš„åå°„èƒ½åŠ›ï¼Œå¦‚ `Reflect.get()`ã€‚
* `reflect-metadata` æ‰©å±•äº† `Reflect`ï¼Œå…è®¸ä½ ä¸ºç±»ã€å±æ€§ã€å‚æ•°ã€æ–¹æ³•é™„åŠ **å…ƒæ•°æ®ï¼ˆmetadataï¼‰**ï¼Œå¹¶åœ¨è¿è¡Œæ—¶è·å–è¿™äº›ä¿¡æ¯ã€‚

> è¿™åœ¨ JavaScript æœ¬èº«æ˜¯åšä¸åˆ°çš„ï¼ŒTypeScript æä¾›äº† `emitDecoratorMetadata` é€‰é¡¹ï¼Œè®©å®ƒæˆä¸ºå¯èƒ½ã€‚

### 1.2 å…ƒæ•°æ®çš„ä½œç”¨

* åœ¨æ¡†æ¶è®¾è®¡ä¸­ç”¨äºï¼šä¾èµ–æ³¨å…¥ã€è·¯ç”±æ³¨å†Œã€æƒé™æ§åˆ¶ã€åºåˆ—åŒ–ã€éªŒè¯ç­‰ã€‚
* ç‰¹åˆ«é€‚åˆç”¨äº\*\*è£…é¥°å™¨ï¼ˆDecoratorï¼‰\*\*ä¸­ï¼Œé€šè¿‡è£…é¥°å™¨è®°å½•é¢å¤–ä¿¡æ¯ã€‚

---

## ğŸ§ª äºŒã€å®Œæ•´ API è¯´æ˜

| æ–¹æ³•                                                                          | æè¿°                                  |
| --------------------------------------------------------------------------- | ----------------------------------- |
| `Reflect.defineMetadata(metadataKey, metadataValue, target, [propertyKey])` | å®šä¹‰å…ƒæ•°æ®                               |
| `Reflect.hasMetadata(metadataKey, target, [propertyKey])`                   | æ˜¯å¦å­˜åœ¨å…ƒæ•°æ®                             |
| `Reflect.getMetadata(metadataKey, target, [propertyKey])`                   | è·å–å…ƒæ•°æ®                               |
| `Reflect.deleteMetadata(metadataKey, target, [propertyKey])`                | åˆ é™¤å…ƒæ•°æ®                               |
| `Reflect.getOwnMetadata()`                                                  | ä¸ `getMetadata` ç±»ä¼¼ï¼Œä½†åªè·å–è‡ªèº«å®šä¹‰çš„ï¼Œä¸åŒ…å«ç»§æ‰¿çš„ |

---

## ğŸ› ï¸ ä¸‰ã€è£…é¥°å™¨ä¸­å¸¸ç”¨çš„ TypeScript è‡ªåŠ¨æ³¨å…¥ç±»å‹å…ƒæ•°æ®

å½“å¯ç”¨ `emitDecoratorMetadata`ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ metadata key è·å–ç±»å‹ä¿¡æ¯ï¼š

| metadata key        | ç”¨é€”         |
| ------------------- | ---------- |
| `design:type`       | å±æ€§ç±»å‹       |
| `design:paramtypes` | æ–¹æ³•å‚æ•°ç±»å‹ï¼ˆæ•°ç»„ï¼‰ |
| `design:returntype` | æ–¹æ³•è¿”å›ç±»å‹     |

---

## ğŸ“˜ å››ã€ç”¨æ³•å…¨æ¡ˆä¾‹è¯¦è§£

### âœ… 4.1 è£…é¥°å±æ€§å¹¶è·å–å…¶ç±»å‹

```ts
import 'reflect-metadata';

class Demo {
  @Reflect.metadata('custom:desc', 'ç”¨æˆ·åå­—æ®µ')
  name: string;
}

const desc = Reflect.getMetadata('custom:desc', Demo.prototype, 'name');
console.log(desc); // ç”¨æˆ·åå­—æ®µ
```

---

### âœ… 4.2 è·å–å±æ€§ç±»å‹ï¼ˆ`design:type`ï¼‰

```ts
import 'reflect-metadata';

class A {
  name: string;
}

const type = Reflect.getMetadata('design:type', A.prototype, 'name');
console.log(type.name); // String
```

---

### âœ… 4.3 è·å–æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ç±»å‹

```ts
import 'reflect-metadata';

class B {
  add(a: number, b: number): number {
    return a + b;
  }
}

console.log(Reflect.getMetadata('design:paramtypes', B.prototype, 'add')); // [ [Function: Number], [Function: Number] ]
console.log(Reflect.getMetadata('design:returntype', B.prototype, 'add')); // [Function: Number]
```

---

### âœ… 4.4 å‚æ•°è£…é¥°å™¨æ”¶é›†ç±»å‹

```ts
function Log(target: Object, propertyKey: string | symbol, parameterIndex: number) {
  const types = Reflect.getMetadata('design:paramtypes', target, propertyKey);
  console.log(`å‚æ•°[${parameterIndex}]ç±»å‹ä¸º: ${types[parameterIndex].name}`);
}

class C {
  hello(@Log name: string) {}
}
// è¾“å‡ºï¼šå‚æ•°[0]ç±»å‹ä¸º: String
```

---

### âœ… 4.5 å­˜å‚¨æ–¹æ³•çº§å…ƒæ•°æ® + éå†

```ts
function Route(method: string) {
  return (target: Object, propertyKey: string) => {
    Reflect.defineMetadata('route', method, target, propertyKey);
  };
}

class Controller {
  @Route('GET')
  getData() {}

  @Route('POST')
  saveData() {}
}

for (const key of Object.getOwnPropertyNames(Controller.prototype)) {
  const method = Reflect.getMetadata('route', Controller.prototype, key);
  if (method) {
    console.log(`${key} => ${method}`);
  }
}
// è¾“å‡º:
// getData => GET
// saveData => POST
```

---

### âœ… 4.6 ç±»æ„é€ å‡½æ•°å‚æ•°ç±»å‹åå°„ï¼ˆDI åŸç†ï¼‰

```ts
class Service {}

class Controller {
  constructor(public service: Service) {}
}

const paramTypes = Reflect.getMetadata('design:paramtypes', Controller);
console.log(paramTypes[0].name); // Service
```

---

## ğŸ”„ äº”ã€ç»§æ‰¿ä¸­çš„å…ƒæ•°æ®è¡Œä¸º

```ts
class Parent {
  @Reflect.metadata('tag', 'parent')
  name: string;
}

class Child extends Parent {}

console.log(
  Reflect.getMetadata('tag', Child.prototype, 'name') // parent
);
console.log(
  Reflect.getOwnMetadata('tag', Child.prototype, 'name') // undefined
);
```

> âœ… `getMetadata` ä¼šé€’å½’æŸ¥æ‰¾ç»§æ‰¿é“¾ï¼Œ`getOwnMetadata` åªæŸ¥å½“å‰ã€‚

---

## ğŸ“¦ å…­ã€å®é™…åœºæ™¯æ€»ç»“

| åœºæ™¯              | å¦‚ä½•åº”ç”¨                         |
| --------------- | ---------------------------- |
| NestJS çš„ DI     | è·å–æ„é€ å‡½æ•°å‚æ•°ç±»å‹ï¼Œè‡ªåŠ¨å®ä¾‹åŒ–             |
| æƒé™æ§åˆ¶            | æ–¹æ³•ä¸Šæ ‡è®°å…ƒæ•°æ®ï¼ˆå¦‚ `@Role('admin')`ï¼‰ |
| è·¯ç”±æ³¨å†Œ            | `@Get()` è£…é¥°å™¨å­˜å…¥è·¯ç”±è¡¨å…ƒæ•°æ®         |
| ORM æ˜ å°„          | æ ‡è®°å­—æ®µçš„ç±»å‹å’Œæ•°æ®åº“æ˜ å°„                |
| class-validator | è£…é¥°å™¨è¯»å–å­—æ®µç±»å‹+æ ¡éªŒè§„åˆ™               |

---

## âš ï¸ ä¸ƒã€ä½¿ç”¨å»ºè®®

* æ€»æ˜¯é…åˆ TypeScript è£…é¥°å™¨ä½¿ç”¨ï¼Œå•ç‹¬ä½¿ç”¨ä¸æ¨èã€‚
* å¼€å‘å¤§å‹æ¡†æ¶æ—¶ï¼Œ`reflect-metadata` æ˜¯æ„å»ºè£…é¥°å™¨ä½“ç³»çš„åº•å±‚æ ¸å¿ƒã€‚
* æ³¨æ„ç±»å‹ä¸¢å¤±é—®é¢˜ï¼Œæ¥å£ç±»å‹æ— æ³•åå°„ï¼ˆæ¥å£ç¼–è¯‘åä¼šè¢«æ“¦é™¤ï¼‰ã€‚

---

## ğŸ å…«ã€ç¯å¢ƒå‡†å¤‡ & tsconfig é…ç½®

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "strict": true,
    "esModuleInterop": true
  }
}
```

```ts
// main.ts
import 'reflect-metadata';
```

---

