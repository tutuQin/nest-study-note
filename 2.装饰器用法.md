** `reflect-metadata` çš„ä½œç”¨ã€ç”¨æ³•ï¼Œå¹¶é…åˆå¤šä¸ªå®ç”¨ä¾‹å­**ï¼Œå°¤å…¶æ˜¯å®ƒå¦‚ä½•ç»“åˆ TypeScript è£…é¥°å™¨æ¥å®ç°é«˜çº§åŠŸèƒ½ï¼Œæ¯”å¦‚ä¾èµ–æ³¨å…¥ã€ç±»å‹æ¨æ–­ã€å­—æ®µæ³¨è§£ç­‰ã€‚

---

## ğŸ§  ä¸€ã€`reflect-metadata` æ˜¯ä»€ä¹ˆï¼Ÿ

`reflect-metadata` æ˜¯ä¸€ä¸ªæ”¯æŒ **å…ƒç¼–ç¨‹ï¼ˆMeta Programmingï¼‰** çš„åº“ï¼Œå®ƒå…è®¸ä½ ç»™ç±»ã€å±æ€§ã€æ–¹æ³•ã€å‡½æ•°å‚æ•°æ·»åŠ â€œ**å…ƒä¿¡æ¯**â€å¹¶åœ¨è¿è¡Œæ—¶è¯»å–è¿™äº›ä¿¡æ¯ã€‚
å¤§ç™½è¯ï¼šç±»ä¼¼äºä¸­é—´ä»¶ï¼Œä»€ä¹ˆè·¯ç”±ä¸­é—´ä»¶å•¥çš„ï¼Œå†™å¥½ååŠ åœ¨é‚£ä¸ªæ–¹æ³•ä¸Šå°±èƒ½å»æ“ä½œé‚£ä¸ªæ–¹æ³•çš„æˆ–è€…ç±»å•¥çš„èƒ½åŠ›ï¼Œæ¯”å¦‚å†™ä¸ªæ—¥å¿—æ‰“å°ï¼Œæ·»åŠ åˆ°çš„å‡½æ•°éƒ½ä¼šè¢«æ‰“å°æ—¥å¿—ï¼Œæ¯”å¦‚è·¯ç”±ä¸­é—´ä»¶æœ¬èº«ä¹Ÿæ˜¯æœ‰ç§å…ƒç¼–ç¨‹èƒ½åŠ›ï¼ŒåŠ ä¸Šå°±èƒ½åœ¨åŠ ä¸Šçš„è·¯ç”±ä¸Šéƒ½æ‰§è¡Œä¸­é—´ä»¶ï¼Œæˆ–è€…Refetï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰å¯¹è±¡çš„å±æ€§æ–¹æ³•å•¥çš„ï¼Œproxyï¼Œè¢«proxyä»£ç†çš„å˜é‡éƒ½ä¼šè¢«ç›‘æ§getsetç­‰ç­‰ï¼Œæ€»ä¹‹å°±æ˜¯å¯ä»¥æå…¶ä»–å†™å¥½çš„ç¨‹åºçš„ç¨‹åºå°±å–Šå…·æœ‰å…ƒç¼–ç¨‹èƒ½åŠ›çš„ç¨‹åº
---

## ğŸ¯ äºŒã€åº”ç”¨åœºæ™¯

| åº”ç”¨         | æè¿°            |
| ---------- | ------------- |
| ğŸ§± ç±»å‹ç³»ç»Ÿæ‰©å±•  | è¯»å–ç±»ã€æ–¹æ³•ã€å‚æ•°çš„ç±»å‹  |
| ğŸ“¦ ä¾èµ–æ³¨å…¥æ¡†æ¶  | è‡ªåŠ¨æ³¨å…¥æ„é€ å‡½æ•°å‚æ•°çš„å®ä¾‹ |
| ğŸ“Š è¡¨å•/æ•°æ®æ ¡éªŒ | è¯»å–å­—æ®µç±»å‹ä¸æ ¡éªŒè§„åˆ™   |
| ğŸ§© ORM æ˜ å°„  | æ ‡æ³¨ç±»å­—æ®µ â†’ æ•°æ®åº“å­—æ®µ |
| ğŸŒ è·¯ç”±æ§åˆ¶å™¨   | ä½¿ç”¨è£…é¥°å™¨å®šä¹‰è·¯ç”±ã€æ–¹æ³•ç­‰ |

---

## âœ… ä¸‰ã€å¯ç”¨ reflect-metadata å‰æ

1. å®‰è£…ï¼š

```bash
npm install reflect-metadata
```

2. åœ¨å…¥å£æ–‡ä»¶ï¼ˆå¦‚ `main.ts`ï¼‰é¡¶éƒ¨å¼•å…¥ï¼š

```ts
import 'reflect-metadata'
```

3. `tsconfig.json` é…ç½®ï¼š

```json
{
  "experimentalDecorators": true,
  "emitDecoratorMetadata": true
}
```

---

## ğŸš€ å››ã€æ ¸å¿ƒ API ç”¨æ³•ç¤ºä¾‹

### âœ… 1. å±æ€§å…ƒæ•°æ®ï¼ˆä½¿ç”¨è£…é¥°å™¨ + metadataï¼‰

```ts
import 'reflect-metadata'

function Label(label: string) {
  return Reflect.metadata('label', label)
}

class User {
  @Label('ç”¨æˆ·å')
  name: string
}

// è·å– name å­—æ®µçš„è‡ªå®šä¹‰å…ƒä¿¡æ¯
const label = Reflect.getMetadata('label', User.prototype, 'name')
console.log(label) // è¾“å‡ºï¼šç”¨æˆ·å
```

---

### âœ… 2. è¯»å–å±æ€§çš„**ç±»å‹ä¿¡æ¯**ï¼ˆéœ€è¦ emitDecoratorMetadataï¼‰

```ts
import 'reflect-metadata'

class User {
  name: string
  age: number
}

const type1 = Reflect.getMetadata('design:type', User.prototype, 'name')
const type2 = Reflect.getMetadata('design:type', User.prototype, 'age')

console.log(type1.name) // String
console.log(type2.name) // Number
```

* è¿™æ˜¯ TypeScript ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ç±»å‹ä¿¡æ¯ã€‚
* `design:type` æ˜¯ reflect-metadata ä¿ç•™çš„ keyã€‚

---

### âœ… 3. è¯»å–æ–¹æ³•å‚æ•°ç±»å‹ï¼ˆç”¨äºä¾èµ–æ³¨å…¥ï¼‰

```ts
import 'reflect-metadata'

class LoggerService {}
class UserService {}

class App {
  constructor(public logger: LoggerService, public userService: UserService) {}
}

const paramTypes = Reflect.getMetadata('design:paramtypes', App)
console.log(paramTypes.map((t: any) => t.name)) // ['LoggerService', 'UserService']
```

* åœ¨ä¾èµ–æ³¨å…¥æ¡†æ¶ä¸­ï¼Œæ¡†æ¶å°±èƒ½æ ¹æ®è¿™äº›ç±»å‹è‡ªåŠ¨åˆ›å»ºå’Œæ³¨å…¥å®ä¾‹ã€‚

---

### âœ… 4. è‡ªå®šä¹‰å­—æ®µéªŒè¯è£…é¥°å™¨

```ts
import 'reflect-metadata'

function Required(target: any, key: string) {
  Reflect.defineMetadata('required', true, target, key)
}

function isFieldRequired(target: any, key: string) {
  return Reflect.getMetadata('required', target, key)
}

class Product {
  @Required
  name: string

  price: number
}

console.log(isFieldRequired(Product.prototype, 'name')) // true
console.log(isFieldRequired(Product.prototype, 'price')) // undefined
```

---

## ğŸŒ äº”ã€ç»“åˆåœºæ™¯ç¤ºä¾‹ï¼šæ„å»ºç®€æ˜“ä¾èµ–æ³¨å…¥å®¹å™¨

```ts
import 'reflect-metadata'

class Logger {
  log(msg: string) {
    console.log('Log:', msg)
  }
}

class Service {
  constructor(public logger: Logger) {}
}

// ç®€æ˜“ DI å®¹å™¨
function create<T>(target: new (...args: any[]) => T): T {
  const paramTypes = Reflect.getMetadata('design:paramtypes', target) || []
  const params = paramTypes.map((type: any) => new type())
  return new target(...params)
}

const service = create(Service)
service.logger.log('Hello DI') // è¾“å‡ºï¼šLog: Hello DI
```

> ğŸ¯ åˆ©ç”¨ `design:paramtypes` è¯»å–æ„é€ å‡½æ•°å‚æ•°ç±»å‹ï¼Œå¹¶è‡ªåŠ¨åˆ›å»ºä¾èµ–é¡¹å®ä¾‹ã€‚

---

## âš ï¸ å…­ã€æ³¨æ„äº‹é¡¹

| é™åˆ¶                      | æè¿°                           |
| ----------------------- | ---------------------------- |
| ç±»å‹ä¿¡æ¯åªåœ¨ TS ç¼–è¯‘æ—¶ç”Ÿæˆ         | å¿…é¡»å¼€å¯ `emitDecoratorMetadata` |
| å¿…é¡»å¼•å…¥ `reflect-metadata` | å¦åˆ™ Reflect API ä¸å¯ç”¨           |
| è¿è¡Œæ—¶ç±»å‹æ˜¯æ„é€ å‡½æ•°              | ä¾‹å¦‚ `String`ã€`Number`ï¼Œä¸æ˜¯å…·ä½“å€¼ç±»å‹ |

---

## ğŸ§¾ ä¸ƒã€å¸¸ç”¨å†…ç½® Metadata Key

| Key                 | æè¿°             |
| ------------------- | -------------- |
| `design:type`       | å±æ€§çš„ç±»å‹          |
| `design:paramtypes` | æ„é€ å‡½æ•°æˆ–æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ |
| `design:returntype` | æ–¹æ³•çš„è¿”å›ç±»å‹        |

---

## âœ… æ€»ç»“

| ç‚¹         | å†…å®¹                                                                 |
| --------- | ------------------------------------------------------------------ |
| ğŸ“¦ å·¥å…·     | `reflect-metadata` æä¾›åœ¨è¿è¡Œæ—¶å®šä¹‰/è·å–å…ƒä¿¡æ¯çš„èƒ½åŠ›                               |
| ğŸ”§ æ­é…     | å¸¸ä¸è£…é¥°å™¨ã€TypeScript ä¸€èµ·ä½¿ç”¨                                              |
| ğŸ’¡ åº”ç”¨     | ä¾èµ–æ³¨å…¥ã€ç±»å‹åå°„ã€è¡¨å•æ ¡éªŒã€ORM ç­‰åœºæ™¯å¹¿æ³›ä½¿ç”¨                                         |
| ğŸ“Œ æ ¸å¿ƒ API | `Reflect.defineMetadata()`ã€`Reflect.getMetadata()`ã€`design:type` ç­‰ |
| ğŸš€ å¿…å¤‡é…ç½®   | `experimentalDecorators: true` + `emitDecoratorMetadata: true`     |

---